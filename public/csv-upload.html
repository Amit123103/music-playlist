<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import CSV | SonicMind</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav>
        <div class="logo">
            <i class="fas fa-wave-square"></i>
            Sonic<span>Mind</span>
        </div>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="player.html">Web Player</a>
            <a href="upload.html">Library</a>
            <a href="csv-upload.html" class="active" style="color:var(--primary)">CSV Import</a>
            <a href="generator.html">Generator</a>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px; max-width: 800px;">
        <header style="margin-bottom: 3rem; text-align: center;">
            <h1 style="font-size: 2.5rem;">Import Dataset</h1>
            <p>Upload a CSV file containing track metadata to bulk-add music to your library.</p>
        </header>

        <div class="glass" style="padding: 3rem;">
            <div class="upload-zone" id="csvDropZone">
                <i class="fas fa-file-csv" style="font-size: 3rem; margin-bottom: 1rem; color: var(--primary);"></i>
                <p>Drag & Drop CSV File<br>or <span style="color: var(--primary); cursor:pointer;">Browse</span></p>
                <input type="file" id="csvInput" accept=".csv"
                    style="opacity: 0; position: absolute; width: 1px; height: 1px;">
            </div>

            <div style="margin-top: 2rem;">
                <h4>Expected Format</h4>
                <div
                    style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 10px; margin-top: 0.5rem; font-family: monospace; font-size: 0.9rem;">
                    Title,Artist,Album,Duration,BPM,Energy,Valence<br>
                    "Midnight City","M83","Hurry Up",243,105,0.8,0.6<br>
                    ...
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Note: Duration in seconds.
                    Energy/Valence range 0.0 - 1.0.</p>
            </div>

            <div id="uploadStatus" style="margin-top: 1rem; text-align: center;"></div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Specific CSV logic bridging to app.js functionality
        const csvDrop = document.getElementById('csvDropZone');
        const csvInput = document.getElementById('csvInput');
        const statusEl = document.getElementById('uploadStatus');

        csvDrop.addEventListener('click', () => csvInput.click());

        csvDrop.addEventListener('dragover', (e) => {
            e.preventDefault();
            csvDrop.style.borderColor = 'var(--primary)';
            csvDrop.style.background = 'var(--glass)';
        });

        csvDrop.addEventListener('dragleave', (e) => {
            e.preventDefault();
            csvDrop.style.borderColor = 'var(--glass-border)';
            csvDrop.style.background = 'transparent';
        });

        csvDrop.addEventListener('drop', (e) => {
            e.preventDefault();
            csvDrop.style.borderColor = 'var(--glass-border)';
            csvDrop.style.background = 'transparent';

            if (e.dataTransfer.files.length > 0) {
                handleCSV(e.dataTransfer.files[0]);
            }
        });

        csvInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleCSV(e.target.files[0]);
        });

        async function handleCSV(file) {
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                alert('Please upload a valid CSV file.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            statusEl.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Parsing CSV...</p>';

            try {
                const res = await fetch('/api/upload-csv', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    statusEl.innerHTML = `<p style="color: #4ade80"><i class="fas fa-check-circle"></i> ${data.message}</p>`;
                    setTimeout(() => window.location.href = 'upload.html', 1500);
                } else {
                    statusEl.innerHTML = `<p style="color: #ef4444">Upload failed.</p>`;
                }
            } catch (e) {
                console.error(e);
                statusEl.innerHTML = `<p style="color: #ef4444">Error uploading file.</p>`;
            }
        }
    </script>
</body>

</html>